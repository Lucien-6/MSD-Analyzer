# MSD Analyzer V1.2

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![Python Version](https://img.shields.io/badge/python-3.10%2B-blue.svg)](https://www.python.org/)
[![Version](https://img.shields.io/badge/version-1.2-brightgreen.svg)](https://github.com/Lucien-6/MSD-Analyzer/releases)

MSD Analyzer 是一款专业的均方位移 (Mean Squared Displacement, MSD) 分析桌面应用程序。它提供了友好的图形用户界面，支持2D/3D粒子轨迹数据的导入、处理、可视化，并提供多种物理模型拟合与参数提取功能，适用于布朗运动、扩散过程和微观粒子动力学研究。

## 📜 目录

- [MSD Analyzer](#msd-analyzer)
  - [📜 目录](#-目录)
  - [🚀 主要功能](#-主要功能)
  - [🛠️ 技术栈](#️-技术栈)
  - [⚙️ 安装](#️-安装)
  - [▶️ 运行](#️-运行)
  - [📖 使用方法](#-使用方法)
  - [🚀 发布与打包](#-发布与打包)
  - [📄 许可证](#-许可证)

## 🚀 主要功能

### 数据导入与处理
- **多格式支持**: 支持从 Excel (.xlsx, .xls) 和 CSV (.csv) 格式导入轨迹数据
- **灵活的列名映射**: 自动识别多种列名格式（T/Time/times, X/Position_X/Center_X等）
- **2D/3D轨迹支持**: 自动检测并处理二维或三维粒子运动轨迹
- **多粒子管理**: 支持同时加载和分析多个粒子的轨迹数据
- **粒子筛选**: 可选择性排除特定粒子，灵活控制分析范围

### MSD计算与分析
- **高效并行计算**: 自动根据数据量选择串行或并行计算模式，充分利用多核CPU
- **完整MSD计算**: 计算每个粒子的单独MSD和所有粒子的平均MSD
- **动态扩散系数(RDC)**: 自动计算并可视化RDC曲线
- **统计信息**: 提供每个时间点参与平均的粒子数量统计

### 多模型拟合
- **简单扩散模型**: 适用于纯布朗运动 (MSD = 2dDt)
- **定向扩散模型**: 适用于有定向漂移的运动 (MSD = 2dDt + V²t²)
- **受限扩散模型**: 适用于受限空间内的扩散 (MSD = L²(1-exp(-2dDt/L²)))
- **自动拟合模式**: 通过RDC分析自动确定最佳拟合区间
- **手动拟合模式**: 用户自定义拟合时间范围
- **置信区间计算**: 提供所有拟合参数的95%置信区间

### 标度律分析
- **双对数分析**: 在双对数坐标下分析MSD随时间的标度关系 (MSD ~ t^α)
- **扩散类型判断**: 自动识别正常扩散、次扩散或超扩散
- **标度指数提取**: 精确计算标度指数α及其置信区间

### 交互式可视化
- **轨迹图交互**: 
  - 左键点击轨迹：单独显示该轨迹
  - 右键点击轨迹：隐藏该轨迹
  - 双击空白处：恢复显示所有轨迹
  - 鼠标悬停显示粒子ID
- **多图表展示**: 轨迹图、MSD图、统计量图、RDC图、拟合图、双对数图
- **专业图表工具栏**: 支持缩放、平移、保存等操作
- **自然排序**: 粒子ID按自然顺序排列显示

### 结果导出
- **Excel数据导出**: 将所有分析结果导出为结构化的Excel文件
- **PDF综合报告**: 自动生成包含所有图表和分析结果的专业PDF报告
- **高质量图片**: 支持导出300 DPI的PNG格式图片
- **完整参数记录**: 报告中包含所有分析设置和参数信息

### 用户体验
- **现代化GUI**: 基于 PyQt5 构建，采用Fusion风格，界面美观直观
- **单位自定义**: 支持多种时间单位（μs, ms, s, min, h）和空间单位（m, mm, μm, nm）
- **实时状态反馈**: 状态栏实时显示操作进度和提示信息
- **内置帮助文档**: 双击"单位设置"标题栏即可查看详细使用指南
- **错误处理**: 完善的异常处理机制，友好的错误提示

## 🛠️ 技术栈

### 核心技术
- **Python 3.10+**: 主要开发语言
- **PyQt5 ≥5.15.0**: 图形用户界面框架，采用Fusion风格

### 科学计算
- **NumPy ≥1.20.0**: 高性能数值计算
- **Pandas ≥1.3.0**: 数据处理与分析
- **SciPy ≥1.7.0**: 科学计算和曲线拟合

### 可视化
- **Matplotlib ≥3.4.0**: 专业级科学绘图，使用Qt5Agg后端
- **支持2D/3D绘图**: 使用mpl_toolkits.mplot3d

### 数据导入导出
- **OpenPyXL ≥3.0.0**: Excel文件读写
- **XlsxWriter ≥3.0.0**: Excel高级格式化导出
- **ReportLab ≥3.6.0**: PDF报告生成

### 性能优化
- **多线程并行计算**: 使用ThreadPoolExecutor实现MSD并行计算
- **向量化运算**: 充分利用NumPy向量化操作提升性能
- **智能计算策略**: 根据数据量自动选择串行或并行模式

## ⚙️ 安装

1.  **克隆仓库**

    ```bash
    git clone https://github.com/Lucien-6/MSD-Analyzer.git
    cd MSD-Analyzer
    ```

2.  **创建并激活虚拟环境 (推荐)**

    **首选方式：使用 Conda**

    ```bash
    # 创建新的 conda 环境 (例如，命名为 msd_env，使用 Python 3.10)
    conda create -n msd_env python=3.10
    # 激活环境
    conda activate msd_env
    ```

    **备选方式：使用 venv**

    ```bash
    python -m venv venv
    # Windows
    .\venv\Scripts\activate
    # macOS/Linux
    source venv/bin/activate
    ```

3.  **安装依赖**
    ```bash
    pip install -r requirements.txt
    ```

## ▶️ 运行

安装完依赖后，通过以下命令运行应用程序：

```bash
python main.py
```

应用程序启动后，会显示欢迎信息。根据提示，您可以 "双击'单位设置'查看使用指南" 以获取更详细的操作说明。

## 📖 使用方法

### 快速开始

详细的使用指南请双击应用内"单位设置"标题栏查看完整帮助文档。

### 基本工作流程

1. **设置单位**（重要！）
   - 在加载数据前先设置好时间单位和空间单位
   - 支持的时间单位：μs, ms, s, min, h
   - 支持的空间单位：m, mm, μm, nm

2. **加载数据**
   - 点击"加载数据"按钮
   - 选择Excel (.xlsx, .xls) 或CSV (.csv) 文件
   - 程序自动识别数据维度（2D或3D）和粒子数量

3. **数据格式要求**
   - **Excel格式**: 每个粒子的轨迹保存在单独的sheet中，sheet名称即为粒子ID
   - **CSV格式**: 可使用particle_id列区分不同粒子，或作为单粒子数据
   - **必需列**: T(时间), X, Y (2D) 或 T, X, Y, Z (3D)
   - **列名灵活**: 支持多种列名格式，如Time/times/T, Position_X/Center_X/X等

4. **选择扩散模型**
   - **简单扩散**: 纯布朗运动
   - **定向扩散**: 有恒定漂移速度的运动
   - **受限扩散**: 在有限空间内的扩散

5. **配置拟合参数**
   - **自动拟合**: 程序自动寻找最佳拟合区间（推荐）
   - **手动拟合**: 自定义起始和终止时间
   - 设置拟合优度阈值（R²）

6. **筛选粒子**（可选）
   - 在粒子列表中选择要排除的粒子
   - 或通过轨迹图交互操作隐藏特定轨迹

7. **计算MSD**
   - 点击"计算MSD"按钮
   - 程序自动计算所有粒子的MSD和平均MSD
   - 大数据量时自动启用并行计算加速

8. **拟合分析**
   - 点击"拟合MSD"按钮进行模型拟合
   - 查看扩散系数D、漂移速度V或约束长度L等参数
   - 所有参数都提供95%置信区间

9. **标度律分析**
   - 点击"标度律分析"按钮
   - 分析MSD的标度关系 (MSD ~ t^α)
   - 判断扩散类型（正常/次/超扩散）

10. **保存结果**
    - 点击"完成并保存"按钮
    - 选择保存目录
    - 自动生成Excel数据文件和PDF综合报告

### 交互式功能

**轨迹图交互**:
- 左键点击某条轨迹：只显示该轨迹
- 右键点击某条轨迹：隐藏该轨迹
- 双击空白处：恢复显示所有轨迹
- 鼠标悬停：显示粒子ID

**图表工具栏**:
- 所有图表都配备专业工具栏
- 支持缩放、平移、保存、调整等操作

### 性能提示

- 粒子数量>10或总计算量>100000时自动启用并行计算
- 并行计算利用多核CPU（保留2个核心给系统）
- 大数据集建议使用自动拟合模式

## 🚀 发布与打包

### 推荐：从 Releases 下载

为了方便使用，建议直接从本项目的 GitHub Releases 页面下载最新版本的预编译可执行文件。

➡️ **[前往 Releases 页面](https://github.com/Lucien-6/MSD-Analyzer/releases)**

下载后解压（如果需要），即可直接运行，无需安装 Python 或其他依赖。

### 从源码打包 (可选)

如果您希望自行从源代码构建可执行文件，本项目提供两种打包方式：

#### 方式一：使用 PyInstaller（推荐用于快速打包）

1. 确保已按照 [⚙️ 安装](#️-安装) 部分设置好开发环境
2. 安装 PyInstaller：
   ```bash
   pip install pyinstaller
   ```
3. 运行打包脚本：
   ```bash
   python build_exe.py
   ```
4. 打包完成后，可执行文件位于 `dist/MSD Analyzer/` 目录

**特点**：
- 打包速度快
- 生成多文件分发包
- 适合开发测试阶段

#### 方式二：使用 Nuitka（推荐用于正式发布）

1. 确保已按照 [⚙️ 安装](#️-安装) 部分设置好开发环境
2. 安装 Nuitka：
   ```bash
   pip install nuitka
   ```
3. 安装 C 编译器（Windows推荐使用 MinGW64 或 MSVC）
4. 运行 Nuitka 打包脚本：
   ```bash
   python build_nuitka.py
   ```
5. 打包完成后，可执行文件位于 `nuitka_build/main.dist/` 目录

**特点**：
- 编译为原生机器码，性能更优
- 启动速度更快
- 可生成单文件可执行程序
- 文件体积更小
- 适合正式发布

#### 使用 UPX 压缩（可选）

项目包含 UPX 工具（位于 `tools/UPX/`），可进一步压缩可执行文件：

```bash
tools\UPX\upx.exe --best --lzma dist\MSD Analyzer\*.exe
```

**注意**：压缩后启动速度可能略有下降，但文件体积可减少50-70%。

## 📄 许可证

本项目采用 [MIT 许可证](LICENSE)授权。
