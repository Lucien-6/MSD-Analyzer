# 帮助文档内容

def get_help_content():
    """返回帮助文档内容"""
    return """

# MSD Analyzer V1.6 使用指南
###
## 简介
**MSD Analyzer V1.6**是一个专业的粒子均方位移(Mean Squared Displacement, MSD)分析工具，专为研究布朗运动、扩散过程和微观粒子动力学而设计。本软件支持2D/3D轨迹数据分析，提供多种扩散模型拟合，包括简单扩散、定向扩散、受限扩散和**活性细菌扩散**（V1.6新增），并具备高效的向量化计算、智能并行计算能力和丰富的交互式可视化功能。完整支持 **TrackMate 数据格式**，可直接导入 ImageJ/Fiji TrackMate 插件导出的轨迹数据，并自动优化数据处理流程。
###
## 作者信息
- **作者**：Lucien
- **EMAIL**：lucien-6@qq.com
- **版本**：V1.6
- **更新日期**：2026年1月
###
## 基本工作流程
1. 加载数据
2. 设置分析参数
3. 计算MSD
4. 拟合MSD曲线
5. 进行标度律分析
6. 保存结果和生成报告
###
---
###
## 详细步骤
###
### 1. 加载数据
- 点击"**加载数据**"按钮
- 支持的文件格式：
  * **Excel文件**(.xlsx或.xls格式)
  * **CSV文件**(.csv格式)
  
#### Excel数据格式要求：
- 每个粒子的轨迹数据应包含时间列和坐标列
- 第一行为标题行，包含T、X、Y三列(2D运动)或T、X、Y、Z四列(3D运动)
- 不同颗粒的轨迹应保存在不同sheet中
- 每个颗粒的ID就是它的sheet名称

#### CSV数据格式要求：
- 第一行为标题行，包含T、X、Y三列(2D运动)或T、X、Y、Z四列(3D运动)
- 可用"particle_id"列来区分不同的颗粒，如果没有此列，所有数据将被视为单个颗粒

#### ✨ TrackMate 数据格式完整支持（V1.5-1.6 智能优化）：
程序**完美支持 ImageJ/Fiji TrackMate 插件导出的 CSV 文件**，并在 V1.5-1.6 版本中进行了全面优化！

**基础功能**：
- **自动格式检测**：智能识别3行或4行头部的 TrackMate 格式
- **自动跳过元数据行**：描述行和单位行自动跳过，确保数据纯净
- **导出方式**：在 TrackMate 中选择 "Analysis" → "Spots in tracks statistics" → "Export to CSV"

**V1.5-1.6 智能优化**：
- **时间列优先级映射**：优先使用 POSITION_T（实际时间）而非 FRAME（帧号）
- **颗粒ID规范化**：自动将浮点数ID（如 0.0）转换为整数字符串（"0"）
- **智能维度识别**：Z列全为0时自动识别为2D数据，避免误判
- **轨迹时间排序**：自动对每条轨迹按时间排序，确保数据连续性
- **数据质量保证**：自动清理、规范化索引，提升数据完整性

**支持的 TrackMate 列名**：
  * TRACK_ID → 粒子ID（自动转换为整数）
  * POSITION_T → 时间（优先）
  * FRAME → 时间（备选）
  * POSITION_X → X坐标
  * POSITION_Y → Y坐标
  * POSITION_Z → Z坐标（全为0时自动识别为2D）

**开箱即用**：无需任何预处理，直接导入即可完美分析！

#### 灵活的列名支持（智能优先级）：
程序支持多种列名格式，并采用智能优先级映射：
- **时间列**（优先级从高到低）: POSITION_T → T → Time → time → Times → times → FRAME
  * 对于 TrackMate 数据，优先使用 POSITION_T（实际时间）而非 FRAME（帧号）
- **粒子ID**（优先级从高到低）: TRACK_ID → ParticleID → Particle_ID → PID → ID → Particle → pid → id
  * 自动转换为整数字符串，如 0.0 → "0"
- **X坐标**: X, Position_X, Position_x, Center_X, Center_x, CenterX, center_x, POSITION_X
- **Y坐标**: Y, Position_Y, Position_y, Center_Y, Center_y, CenterY, center_y, POSITION_Y
- **Z坐标**: Z, Position_Z, Position_z, Center_Z, Center_z, CenterZ, center_z, POSITION_Z
  * 全为0时自动识别为2D数据

**无需修改数据文件的列名，程序会自动智能适配！**

#### 数据加载后：
- 程序会**智能检测轨迹维度**（Z列全为0时自动识别为2D）
- **自动识别粒子数量**（颗粒ID自动转换为整数）
- **轨迹自动排序**（每条轨迹按时间从小到大排序）
- **显示交互式轨迹图**（支持点击、悬停等交互）
- **粒子列表显示**（所有粒子ID按自然顺序排列）
- **数据质量保证**（索引规范化、数据清理）
###
### 2. 单位设置
- 时间单位：**μs**(微秒)、**ms**(毫秒)、**s**(秒)、**min**(分钟)、**h**(小时)
- 空间单位：**m**(米)、**mm**(毫米)、**μm**(微米)、**nm**(纳米)
- 单位设置仅影响图表和结果的单位显示，不改变原始数值计算
- ⚠️ **重要提示**：请在加载数据前设置好单位，中途更改需要重新加载数据并从头处理！
###
### 3. 扩散模型设置
程序提供四种扩散模型，根据您的实验体系选择合适的模型：

#### 简单扩散模型（纯布朗运动）
- **适用场景**：自由扩散，无外力，无约束
- **拟合公式**：MSD(t) = 2dDt
  * d：维度（2或3）
  * D：扩散系数
- **典型应用**：稀溶液中的胶体粒子、自由扩散的分子
- **判断依据**：标度指数α ≈ 1

#### 定向扩散模型（漂移速度恒定）
- **适用场景**：存在恒定外力或定向流动
- **拟合公式**：MSD(t) = 2dDt + V²t²
  * D：扩散系数（随机运动部分）
  * V：漂移速度（定向运动部分）
- **典型应用**：重力场中的沉降、电场驱动、流体对流
- **判断依据**：标度指数α > 1.1，MSD曲线在长时间呈二次增长
- **物理意义**：第一项代表随机扩散，第二项代表定向漂移

#### 受限扩散模型（圆内或球内）
- **适用场景**：粒子运动受空间限制
- **拟合公式**：MSD(t) = L²(1 - exp(-2dDt/L²))
  * D：扩散系数
  * L：约束长度（受限空间的特征尺寸）
- **典型应用**：细胞内区室、多孔材料、膜蛋白
- **判断依据**：MSD曲线在长时间趋于平台
- **物理意义**：短时间呈线性增长，长时间趋于L²
- **⚠️ 注意**：受限扩散模型不支持自动拟合，必须使用手动拟合模式

#### 🆕 活性细菌扩散模型（Run-and-Tumble，V1.6新增）
- **适用场景**：活性粒子的间歇性运动
- **拟合公式**：MSD(t) = 2dD_eff(t - τ_r(1 - e^(-t/τ_r)))
  * D_eff：有效扩散系数
  * τ_r：重定向时间（reorientation time）
- **典型应用**：细菌游动（E. coli等）、活性胶体、微生物运动
- **判断依据**：短时间弹道运动（MSD ~ t²），长时间有效扩散（MSD ~ t）
- **物理意义**：
  * 短时（t << τ_r）：粒子以恒定速度直线运动，MSD ~ t²
  * 长时（t >> τ_r）：方向随机化，表现为有效扩散，MSD ~ t
  * τ_r表征粒子改变运动方向的特征时间尺度
- **参数关系**：D_eff = v²τ_r/(2d)，其中v为游泳速度
- **支持自动拟合**：可使用自动或手动拟合模式
###
### 4. 拟合设置
- **自动拟合模式**：
  * 程序通过分析RDC(动态扩散系数曲线)自动确定最佳拟合区间
  * 设置起始时间：指定从哪个时间点开始寻找拟合区间
  * 拟合优度阈值(R²)：设置接受拟合结果的最低R²值
  * 程序会寻找满足R²阈值的最长区间
  * ⚠️ 自动拟合模式不适用于受限扩散模型！
- **手动拟合模式**：
  * 手动指定拟合的起始时间和终止时间
  * 适用于需要精确控制拟合区间的情况
###
### 5. 颗粒选择与轨迹管理
- 颗粒列表显示所有已加载的颗粒ID
- 可以选择排除某些颗粒不参与分析
- 轨迹图交互功能：
  * **左键点击**某条轨迹：只显示该轨迹
  * **右键点击**某条轨迹：隐藏该轨迹
  * **双击空白处**：恢复显示所有轨迹
- 轨迹图标记说明：
  * **▲ (Triangle/三角形)**：轨迹起点 (Start Point) - 表示粒子运动的初始位置
  * **● (Circle/圆点)**：轨迹终点 (End Point) - 表示粒子运动的最终位置
- 轨迹图比例说明：
  * X轴与Y轴比例严格保持1:1，确保轨迹形态不失真
###
### 6. 计算MSD
- 点击"**计算MSD**"按钮
- 程序会计算：
  * 每个粒子的单独MSD
  * 所有粒子的平均MSD
  * 动态扩散系数(RDC)
  
#### 进度显示：
- 计算过程中，状态栏右侧会显示**进度条**
- 进度条实时显示计算进度百分比
- 状态栏文字提示当前计算阶段
- **界面保持响应**：计算在后台线程执行，您可以自由切换选项卡查看其他内容

#### 高效向量化计算：
- V1.3 版本采用 NumPy 向量化操作优化 MSD 计算
- 相比传统嵌套循环，**性能提升 2-5 倍**
- 内存使用更高效

#### 智能并行计算：
- 程序会自动评估数据量，智能选择计算策略
- **自动启用并行计算的条件**：
  * 粒子数量 > 10，或
  * 总计算量（粒子数×平均轨迹长度²）> 100000
- **并行计算特性**：
  * 利用多核CPU加速（保留2个核心给系统）
  * 使用线程池(ThreadPoolExecutor)实现
  * 大幅缩短计算时间（可提速2-8倍）
- **串行计算**：小数据集使用串行计算，避免线程开销

#### 计算完成后生成的图表：
- **MSD图**：
  * 显示每个粒子的单独MSD曲线（半透明）
  * 显示所有粒子的平均MSD（红色粗线）
  * 粒子ID按自然顺序排列
- **统计量图**：
  * 柱状图显示每个时间点参与平均的粒子数量
  * 用于评估统计可靠性
  * 建议关注粒子数量充足的时间范围
- **RDC图**：
  * 显示动态扩散系数随时间的变化
  * RDC = d(MSD)/dt / (2d)
  * 用于自动拟合模式的区间选择
###
### 7. 拟合MSD
- 点击"**拟合MSD**"按钮
- 程序会根据选择的模型和拟合设置拟合MSD曲线
- 拟合结果包括：
  * 扩散系数D及其95%置信区间
  * 漂移速度V及其95%置信区间(定向扩散模型)
  * 约束长度L及其95%置信区间(受限扩散模型)
  * 🆕 有效扩散系数D_eff及重定向时间τ_r(活性细菌扩散模型，V1.6)
  * 拟合优度R²
  * 拟合使用的时间范围
- 拟合曲线会叠加在MSD图上显示
- 🆕 **LaTeX格式显示**（V1.6）：所有公式和参数使用专业数学排版，正确显示上标、下标和数学符号
###
### 8. 标度律分析
- 点击"**标度律分析**"按钮
- 程序会分析MSD随时间的标度关系：MSD ~ t^α
- 分析方法：对MSD和时间取双对数，进行线性拟合
- 分析结果包括：
  * 标度指数α及其95%置信区间
  * 比例系数K及其95%置信区间
  * 拟合优度R²
- 生成双对数MSD图，显示标度关系
###
### 9. 保存结果
- 点击"**完成并保存**"按钮
- 选择保存目录
- 程序会保存以下内容：
  * 所有图表(PNG格式)：轨迹图、MSD图、RDC图、标度律图等
  * 分析结果(Excel格式)：包含所有数值结果和统计信息
  * 综合报告(PDF格式)：包含所有图表和分析结果的完整报告
- 保存的文件会按照分析日期和时间命名
###
---
###
## 结果解读
###
### 扩散系数(D)
- **单位**：空间单位²/时间单位
- **物理意义**：反映粒子扩散的快慢
- **典型值参考**：
  * 水中微米级粒子：~10⁻¹²-10⁻¹⁴ m²/s
  * 细胞内蛋白质：~10⁻¹¹-10⁻¹² m²/s
- **影响因素**：温度、介质粘度、粒子尺寸
###
### 漂移速度(V)
- **单位**：空间单位/时间单位
- **物理意义**：反映粒子在重力或其他外力作用下的定向漂移速度
- **方向**：应始终维持不变
- **斯托克斯沉降速度参考**：V = 2(ρₚ-ρₘ)gr²/9η
  * ρₚ：粒子密度
  * ρₘ：介质密度
  * g：重力加速度
  * r：粒子半径
  * η：介质粘度
###
### 约束长度(L)
- **单位**：空间单位
- **物理意义**：受限扩散中粒子运动的特征约束尺寸
- **应用**：细胞内区室尺寸、多孔材料孔径等估计
###
### 🆕 有效扩散系数(D_eff)与重定向时间(τ_r) - V1.6新增
- **D_eff单位**：空间单位²/时间单位
- **τ_r单位**：时间单位
- **物理意义**：
  * D_eff：活性粒子的长时有效扩散系数
  * τ_r：粒子改变运动方向的特征时间
- **参数关系**：D_eff = v²τ_r/(2d)，其中v为游泳速度
- **典型值参考**：
  * 大肠杆菌：τ_r ~ 1秒，v ~ 30 μm/s
  * 活性胶体：取决于驱动机制（光泳、自泳等）
- **应用**：细菌运动学研究、活性物质物理、微生物行为分析
###
### 标度指数(α)
- MSD ~ t^α
- **扩散类型判断**：
  * α = 1(±0.1)：**简单扩散**(布朗运动)
  * α < 0.9：**次扩散**(受阻扩散)
    - 可能原因：分子拥挤、粘弹性介质、粒子间相互作用
  * α > 1.1：**超扩散**(定向或活性运动)
    - 可能原因：主动运输、流体对流、非平衡系统
###
---
###
## 高级功能与技巧

### 数据质量控制
- **异常粒子排除**：
  * 在粒子列表中选择要排除的粒子
  * 或使用轨迹图交互功能隐藏异常轨迹
  * 排除后需重新计算MSD
- **统计可靠性评估**：
  * 查看统计量图，关注粒子数量充足的时间范围
  * 建议至少有5个以上粒子参与平均
  * 长时间尺度统计误差较大，需谨慎解读

### 拟合策略优化
- **时间尺度选择**：
  * 短时间尺度（初始段）：反映局部扩散行为，受噪声影响较小
  * 中等时间尺度：最佳拟合区间，统计性好
  * 长时间尺度：反映整体趋势，但统计误差大
- **拟合质量评估**：
  * R² > 0.95：优秀拟合
  * 0.90 < R² < 0.95：良好拟合
  * R² < 0.90：需调整拟合区间或更换模型
- **自动vs手动拟合**：
  * 自动拟合：适合标准数据，快速获得结果
  * 手动拟合：适合复杂体系，需要精确控制

### 模型选择指南
1. **先做标度律分析**，根据α值初步判断：
   * α ≈ 1：选择简单扩散模型
   * α > 1.1：选择定向扩散模型
   * α < 0.9：可能是次扩散，考虑受限扩散或其他因素
2. **观察MSD曲线形状**：
   * 线性增长：简单扩散
   * 抛物线增长：定向扩散
   * 趋于平台：受限扩散
3. **比较不同模型的R²值**，选择拟合最好的模型
4. **物理合理性检验**：
   * 扩散系数D应为正值
   * 约束长度L应与实验体系尺度相符
   * 漂移速度V应与预期外力方向一致

### 交互式可视化技巧
- **轨迹图操作**：
  * 左键点击：聚焦单个粒子
  * 右键点击：排除异常粒子
  * 双击空白：恢复全部显示
  * 鼠标悬停：快速识别粒子ID
- **图表工具栏**：
  * 🏠 主页：恢复原始视图
  * ← → ：前后视图切换
  * 🔍 放大镜：框选放大
  * ✋ 平移：拖动图表
  * ⚙️ 配置：调整边距、坐标轴等
  * 💾 保存：导出高质量图片
- **图例管理**：
  * 粒子数量≤20时显示全部ID
  * 粒子数量>20时显示前19个+"更多..."
  * 图例透明度反映粒子可见性

### 性能优化建议
- **大数据集处理**：
  * 充分利用向量化计算和并行计算（自动启用）
  * 先用小数据集测试参数
  * 避免频繁重复计算
- **内存管理**：
  * 超大数据集（>1000粒子）建议分批处理
  * 及时保存结果，避免数据丢失
- **计算时间估算**（V1.3 向量化优化后）：
  * 10个粒子×100时间点：<0.5秒
  * 100个粒子×1000时间点：30秒-2分钟
  * 500个粒子×1000时间点：2-5分钟

### 结果导出与报告
- **Excel文件内容**：
  * 平均MSD数据表
  * 拟合参数及置信区间
  * 标度律分析结果
  * 所有设置参数
- **PDF报告内容**：
  * 封面（含分析设置）
  * 所有图表（高质量）
  * 数据表格
  * 统计分析结果
- **图片导出**：
  * 300 DPI高分辨率PNG格式
  * 适合直接用于论文发表

### 快捷操作
- **帮助文档访问**：
  * 双击"单位设置"标题栏打开本文档
  * 随时查阅，无需退出程序
- **状态栏提示**：
  * 实时显示操作进度
  * 进度条显示计算百分比
  * 显示排除粒子数量
  * 显示计算状态
###
---
###
## 常见问题解答
###
### Q: 为什么我的MSD曲线在长时间尺度上不稳定？
A: 长时间尺度的MSD计算涉及较少的数据点平均，统计误差较大。建议关注统计量图，在参与平均的粒子数量充足的时间范围内进行分析。
###
### Q: 如何判断使用哪种扩散模型？
A: 先进行标度律分析，根据α值初步判断扩散类型，再选择相应模型进行拟合。也可以尝试不同模型，比较R²值选择最佳模型。
###
### Q: 为什么自动拟合找不到满足R²阈值的区间？
A: 可能是R²阈值设置过高或数据质量不佳。尝试降低R²阈值或切换到手动拟合模式。
###
### Q: 如何处理不同时间间隔或不同长度的轨迹数据？
A: 程序会自动处理不规则时间间隔或不同长度的数据，无需特殊处理。MSD计算时会自动对齐不同粒子的时间延迟。
###
### Q: 为什么并行计算没有启用？
A: 并行计算需要满足以下条件之一：(1)粒子数量>10，或(2)总计算量>100000。小数据集使用串行计算反而更快。
###
### Q: 可以同时分析多个数据文件吗？
A: 当前版本不支持批量处理。建议将多个粒子的数据合并到一个Excel文件的不同sheet中，或CSV文件的不同行中。
###
### Q: 导出的PDF报告可以编辑吗？
A: PDF报告是只读格式，但您可以使用专业PDF编辑器进行修改。建议直接使用导出的高质量PNG图片和Excel数据进行论文制作。
###
### Q: 程序支持哪些操作系统？
A: 从源码运行支持Windows、macOS和Linux。预编译可执行文件目前仅提供Windows版本。
###
### Q: 计算过程中界面卡住了怎么办？
A: V1.3 版本采用异步计算，界面不会卡住。如果遇到问题，可能是数据量过大，请耐心等待进度条完成。如进度条长时间无响应，可尝试重启程序。
###
### Q: 如何导入 TrackMate 的数据？
A: 程序完美支持 TrackMate 数据格式（V1.5-1.6 全面优化）！

**导出步骤**：
1. 在 TrackMate 中完成粒子追踪
2. 选择 "Analysis" → "Spots in tracks statistics" → "Export to CSV"
3. 直接在 MSD Analyzer 中加载该 CSV 文件

**自动处理（无需任何手动操作）**：
- ✓ 自动识别 TrackMate 格式（3行/4行头部）
- ✓ 时间列智能映射（POSITION_T 优先于 FRAME）
- ✓ 颗粒ID自动整数化（0.0 → "0"）
- ✓ Z列智能检测（全为0时识别为2D）
- ✓ 轨迹自动排序（按时间从小到大）
- ✓ 数据质量优化（清理+规范化）

**开箱即用，完美兼容！**
###
### Q: 如何引用本软件？
A: 如果在学术论文中使用本软件，请引用：
```
MSD Analyzer V1.6, Lucien, 2026
GitHub: https://github.com/Lucien-6/MSD-Analyzer
```
###
---
###
## 技术支持与反馈
- **问题反馈**：发现bug或有功能建议，请在GitHub提交Issue
- **技术交流**：发送邮件至 lucien-6@qq.com
- **项目主页**：https://github.com/Lucien-6/MSD-Analyzer
- **更新日志**：查看GitHub Releases页面获取最新版本信息
###
---
###
## 版本信息
- **当前版本**：V1.6
- **发布日期**：2026年1月

- **V1.6 主要更新**（当前版本）：
  * 🧬 **活性细菌扩散模型**：新增 Run-and-Tumble 模型，适用于细菌游动、活性胶体等研究
    - 公式：MSD(t) = 2dD_eff(t - τ_r(1 - e^(-t/τ_r)))
    - 提取有效扩散系数 D_eff 和重定向时间 τ_r
    - 支持自动和手动拟合模式
  * 🎨 **完整LaTeX公式支持**：所有4个模型公式使用专业LaTeX格式
    - 正确显示上标（V², t², L²）
    - 正确显示下标（D_eff, τ_r）
    - 正确显示指数（e^(-t/τ_r)）
    - 函数名使用正体（\mathrm{MSD}）
    - 达到顶级期刊论文排版标准
  * 📊 **完善的PDF报告**：活性模型参数在报告和数据表格中完整显示
  * 🔧 **参数显示优化**：GUI和PDF报告中所有模型参数格式统一

- **V1.5 主要更新**：
  * 🎯 **智能列名映射优先级**：时间列优先使用 POSITION_T > T > FRAME，确保 TrackMate 数据时间准确性
  * 📐 **智能2D/3D识别**：当 Z 列全为 0 时自动识别为 2D 数据，避免误判
  * 🔢 **颗粒ID规范化**：自动将浮点数ID转换为整数字符串（如 0.0 → "0"）
  * ⏱️ **轨迹时间排序**：自动对每条轨迹按时间排序，确保数据连续性
  * 🐛 **TrackMate格式检测优化**：修复检测逻辑，正确识别不同格式的 TrackMate 导出文件
  * ✨ **数据处理增强**：改进数据清理和索引规范化，提升数据质量

- **V1.4 主要更新**：
  * 🔬 **TrackMate 兼容**：原生支持 ImageJ/Fiji TrackMate 插件导出的 CSV 数据格式
  * 📂 **自动格式检测**：智能识别 TrackMate CSV 格式，自动跳过元数据行
  * 🏷️ **扩展列名映射**：新增 TRACK_ID, POSITION_X/Y/Z, POSITION_T, FRAME 等列名支持
  * 🔄 **无缝导入**：TrackMate 数据无需预处理，直接导入即可分析

- **V1.3 主要更新**：
  * 🚀 **向量化MSD计算**：采用NumPy向量化操作，性能提升2-5倍
  * 📊 **进度条显示**：MSD计算时显示实时进度条
  * ⚡ **异步非阻塞计算**：后台线程执行计算，界面保持流畅响应
  * 🏗️ **状态管理优化**：采用AppState类集中管理应用状态
  * 📝 **日志系统**：完善的logging系统，警告/错误弹窗提示
  * 🔧 **架构改进**：Worker线程模式，计算与GUI完全解耦

- **V1.2 主要更新**：
  * 完善的列名映射系统
  * 三种扩散模型支持
  * 智能并行计算
  * 增强的交互式可视化
  * 自然排序显示
  * 优化的性能和用户体验
###
"""
